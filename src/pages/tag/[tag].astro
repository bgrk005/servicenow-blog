---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const tagSet = new Set<string>();

  posts.forEach((post) => {
    if (Array.isArray(post.data.tags)) {
      post.data.tags.forEach((tag) => tagSet.add(tag.toLowerCase()));
    }
  });

  return Array.from(tagSet).map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter(
          (post) =>
            Array.isArray(post.data.tags) &&
            post.data.tags.some((t) => t.toLowerCase() === tag),
        )
        .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()),
    },
  }));
}

const { tag: tagParam, posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tagParam}`} description={`Posts tagged with ${tagParam}`}> 
  <h1 class="text-3xl font-bold mt-8 mb-6">Posts tagged "{tagParam}"</h1>
  <div class="grid gap-8 sm:grid-cols-2">
    {posts.length === 0 && <p>No posts found.</p>}
    {posts.map((post) => (
      <PostCard frontmatter={post.data} href={`/posts/${post.slug}/`} />
    ))}
  </div>
</BaseLayout>
